<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Anatomy of Spring Security Basic Workflow | Diving</title>
  <meta name="author" content="Zhenchao Wang">
  
  <meta name="description" content="This post is meant to demystify the internals of spring security, you should be able to understand how spring security hooks back to authentication sc">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Anatomy of Spring Security Basic Workflow"/>
  <meta property="og:site_name" content="Diving"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Diving" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Diving</a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-08-28T16:00:00.000Z"><a href="/2015/08/29/Anatomy-of-Spring-Secuirty-Basic-Workflow/">2015-08-29</a></time>
      
      
  
    <h1 class="title">Anatomy of Spring Security Basic Workflow</h1>
  

    </header>
    <div class="entry">
      
        <p>This post is meant to demystify the internals of spring security, you should be able to understand how spring security hooks back to authentication scenario.</p>
<p>By default, spring security maintains a chain of filters under the cover of the general exposed filter “springSecurityFilterChain”.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"></div><div class="line">    FirewalledRequest fwRequest = firewall.getFirewalledRequest((HttpServletRequest) request); <span class="comment">//specified &lt;security:intercept-url&gt;</span></div><div class="line">    HttpServletResponse fwResponse = firewall.getFirewalledResponse((HttpServletResponse) response);</div><div class="line"></div><div class="line">    List&lt;Filter&gt; filters = getFilters(fwRequest);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (filters == <span class="keyword">null</span> || filters.size() == <span class="number">0</span>) &#123; <span class="comment">//unproctecd, just get you through</span></div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(UrlUtils.buildRequestUrl(fwRequest) +</div><div class="line">                    (filters == <span class="keyword">null</span> ? <span class="string">" has no matching filters"</span> : <span class="string">" has an empty filter list"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fwRequest.reset();</div><div class="line"></div><div class="line">        chain.doFilter(fwRequest, fwResponse);</div><div class="line"></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    VirtualFilterChain vfc = <span class="keyword">new</span> VirtualFilterChain(fwRequest, chain, filters);</div><div class="line">    vfc.doFilter(fwRequest, fwResponse);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>For a complete list of the configured filters by default, please refer to security schema file. In the case of <a href="http://www.springframework.org/schema/security/spring-security-3.2.xsd" target="_blank" rel="external">3.2</a>,<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">xs:simpleType</span> <span class="attr">name</span>=<span class="string">"named-security-filter"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xs:restriction</span> <span class="attr">base</span>=<span class="string">"xs:token"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"FIRST"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"CHANNEL_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"SECURITY_CONTEXT_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"CONCURRENT_SESSION_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"WEB_ASYNC_MANAGER_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"HEADERS_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"CSRF_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"LOGOUT_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"X509_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"PRE_AUTH_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"CAS_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"FORM_LOGIN_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"OPENID_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"LOGIN_PAGE_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"DIGEST_AUTH_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"BASIC_AUTH_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"REQUEST_CACHE_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"SERVLET_API_SUPPORT_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"JAAS_API_SUPPORT_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"REMEMBER_ME_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"ANONYMOUS_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"SESSION_MANAGEMENT_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"EXCEPTION_TRANSLATION_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"FILTER_SECURITY_INTERCEPTOR"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"SWITCH_USER_FILTER"</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">xs:enumeration</span> <span class="attr">value</span>=<span class="string">"LAST"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xs:restriction</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xs:simpleType</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Of course, the chains can be customized. Please refer to <a href="http://docs.spring.io/spring-security/site/docs/3.0.x/reference/security-filter-chain.html" target="_blank" rel="external">spring security doc</a></p>
<p>Here we will stick to the default chains. The class VirtualFilterchain is defined as below,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VirtualFilterChain</span> <span class="keyword">implements</span> <span class="title">FilterChain</span> </span>&#123;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> FilterChain originalChain; <span class="comment">// save the original chain so that can be restored later</span></div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Filter&gt; additionalFilters;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> FirewalledRequest firewalledRequest;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</div><div class="line">     <span class="keyword">private</span> <span class="keyword">int</span> currentPosition = <span class="number">0</span>;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">private</span> <span class="title">VirtualFilterChain</span><span class="params">(FirewalledRequest firewalledRequest, FilterChain chain, List&lt;Filter&gt; additionalFilters)</span> </span>&#123;</div><div class="line">         <span class="keyword">this</span>.originalChain = chain;</div><div class="line">         <span class="keyword">this</span>.additionalFilters = additionalFilters;</div><div class="line">         <span class="keyword">this</span>.size = additionalFilters.size();</div><div class="line">         <span class="keyword">this</span>.firewalledRequest = firewalledRequest;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">         <span class="keyword">if</span> (currentPosition == size) &#123;</div><div class="line">             <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                 logger.debug(UrlUtils.buildRequestUrl(firewalledRequest)</div><div class="line">                         + <span class="string">" reached end of additional filter chain; proceeding with original chain"</span>);</div><div class="line">             &#125;</div><div class="line"></div><div class="line">             <span class="comment">// Deactivate path stripping as we exit the security filter chain</span></div><div class="line">             <span class="keyword">this</span>.firewalledRequest.reset();</div><div class="line"></div><div class="line">             originalChain.doFilter(request, response);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             currentPosition++;</div><div class="line"></div><div class="line">             Filter nextFilter = additionalFilters.get(currentPosition - <span class="number">1</span>);</div><div class="line"></div><div class="line">             <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                 logger.debug(UrlUtils.buildRequestUrl(firewalledRequest) + <span class="string">" at position "</span> + currentPosition + <span class="string">" of "</span></div><div class="line">                     + size + <span class="string">" in additional filter chain; firing Filter: '"</span></div><div class="line">                     + nextFilter.getClass().getSimpleName() + <span class="string">"'"</span>);</div><div class="line">             &#125;</div><div class="line"></div><div class="line">             nextFilter.doFilter(request, response, <span class="keyword">this</span>);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>Now let’s walk through the protection mechanism of spring security.</p>
<p><img src="/images/spring_security.png" alt=""></p>
<p>Steps explained, skipping some filters for simplicity:</p>
<ol>
<li><p>User attempts to access a protected resource, security context persistence filter mainly restores the securitycontext it saved before and clears the security context when the request processing is completed. Does SecurityContextHolder<br>sound similar to thread-local object? Right. It’s threadlocal by default, which makes sense in typical web app. It’s customizable for spring always grants you the opportunity to substitute the default behavior.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">    HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">    HttpServletResponse response = (HttpServletResponse) res;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (request.getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// ensure that filter is only applied once per request</span></div><div class="line">        chain.doFilter(request, response);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> debug = logger.isDebugEnabled();</div><div class="line"></div><div class="line">    request.setAttribute(FILTER_APPLIED, Boolean.TRUE);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (forceEagerSessionCreation) &#123;</div><div class="line">        HttpSession session = request.getSession();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (debug &amp;&amp; session.isNew()) &#123;</div><div class="line">            logger.debug(<span class="string">"Eagerly created session: "</span> + session.getId());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    HttpRequestResponseHolder holder = <span class="keyword">new</span> HttpRequestResponseHolder(request, response);</div><div class="line">    SecurityContext contextBeforeChainExecution = repo.loadContext(holder);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        SecurityContextHolder.setContext(contextBeforeChainExecution);</div><div class="line"></div><div class="line">        chain.doFilter(holder.getRequest(), holder.getResponse());</div><div class="line"></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        SecurityContext contextAfterChainExecution = SecurityContextHolder.getContext();</div><div class="line">        <span class="comment">// Crucial removal of SecurityContextHolder contents - do this before anything else.</span></div><div class="line">        SecurityContextHolder.clearContext();</div><div class="line">        repo.saveContext(contextAfterChainExecution, holder.getRequest(), holder.getResponse());</div><div class="line">        request.removeAttribute(FILTER_APPLIED);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (debug) &#123;</div><div class="line">            logger.debug(<span class="string">"SecurityContextHolder now cleared, as request processing completed"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>If unspecified, the requested URL doesn’t match any filter pattern. Let’s examine what happens when it hits <strong>ANONYMOUS_FILTER</strong>,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (applyAnonymousForThisRequest((HttpServletRequest) req)) &#123;</div><div class="line">        <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</div><div class="line">            SecurityContextHolder.getContext().setAuthentication(createAuthentication((HttpServletRequest) req));</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"Populated SecurityContextHolder with anonymous token: '"</span></div><div class="line">                    + SecurityContextHolder.getContext().getAuthentication() + <span class="string">"'"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"SecurityContextHolder not populated with anonymous token, as it already contained: '"</span></div><div class="line">                    + SecurityContextHolder.getContext().getAuthentication() + <span class="string">"'"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    chain.doFilter(req, res);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Authentication <span class="title">createAuthentication</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">    AnonymousAuthenticationToken auth = <span class="keyword">new</span> AnonymousAuthenticationToken(key, principal, authorities);</div><div class="line">    auth.setDetails(authenticationDetailsSource.buildDetails(request));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> auth;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Yes, this filter creates one AnonymousAuthenticationToken with role “ROLE_ANONYMOUS”.</p>
</li>
<li><p>When filter chain execution reaches <strong>FILTER_SECURITY_INTERCEPTOR</strong>, the validation magic finally kicks off.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></div><div class="line"><span class="function">         <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">     FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</div><div class="line">     invoke(fi);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">     <span class="keyword">if</span> ((fi.getRequest() != <span class="keyword">null</span>) &amp;&amp; (fi.getRequest().getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>)</div><div class="line">             &amp;&amp; observeOncePerRequest) &#123;</div><div class="line">         <span class="comment">// filter already applied to this request and user wants us to observe</span></div><div class="line">         <span class="comment">// once-per-request handling, so don't re-do security checking</span></div><div class="line">         fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="comment">// first time this request being called, so perform security checking</span></div><div class="line">         <span class="keyword">if</span> (fi.getRequest() != <span class="keyword">null</span>) &#123;</div><div class="line">             fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi); <span class="comment">//unauthorized request won't make it here</span></div><div class="line"></div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</div><div class="line">         &#125; <span class="keyword">finally</span> &#123;</div><div class="line">             <span class="keyword">super</span>.finallyInvocation(token);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p> Unauthorized requests won’t survive the line <code>InterceptorStatusToken token = super.beforeInvocation(fi);</code>, all authentication/authorization decisions are made there.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>&#123;</div><div class="line">     Assert.notNull(object, <span class="string">"Object was null"</span>);</div><div class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> debug = logger.isDebugEnabled();</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (!getSecureObjectClass().isAssignableFrom(object.getClass())) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Security invocation attempted for object "</span></div><div class="line">                 + object.getClass().getName()</div><div class="line">                 + <span class="string">" but AbstractSecurityInterceptor only configured to support secure objects of type: "</span></div><div class="line">                 + getSecureObjectClass());</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     Collection&lt;ConfigAttribute&gt; attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource().getAttributes(object);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (attributes == <span class="keyword">null</span> || attributes.isEmpty()) &#123;</div><div class="line">         <span class="keyword">if</span> (rejectPublicInvocations) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Secure object invocation "</span> + object +</div><div class="line">                     <span class="string">" was denied as public invocations are not allowed via this interceptor. "</span></div><div class="line">                             + <span class="string">"This indicates a configuration error because the "</span></div><div class="line">                             + <span class="string">"rejectPublicInvocations property is set to 'true'"</span>);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (debug) &#123;</div><div class="line">             logger.debug(<span class="string">"Public object - authentication not attempted"</span>);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         publishEvent(<span class="keyword">new</span> PublicInvocationEvent(object));</div><div class="line"></div><div class="line">         <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// no further work post-invocation</span></div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (debug) &#123;</div><div class="line">         logger.debug(<span class="string">"Secure object: "</span> + object + <span class="string">"; Attributes: "</span> + attributes);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</div><div class="line">         credentialsNotFound(messages.getMessage(<span class="string">"AbstractSecurityInterceptor.authenticationNotFound"</span>,</div><div class="line">                 <span class="string">"An Authentication object was not found in the SecurityContext"</span>), object, attributes);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     Authentication authenticated = authenticateIfRequired();</div><div class="line"></div><div class="line">     <span class="comment">// Attempt authorization</span></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         <span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">catch</span> (AccessDeniedException accessDeniedException) &#123;</div><div class="line">         publishEvent(<span class="keyword">new</span> AuthorizationFailureEvent(object, attributes, authenticated, accessDeniedException));</div><div class="line"></div><div class="line">         <span class="keyword">throw</span> accessDeniedException;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (debug) &#123;</div><div class="line">         logger.debug(<span class="string">"Authorization successful"</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (publishAuthorizationSuccess) &#123;</div><div class="line">         publishEvent(<span class="keyword">new</span> AuthorizedEvent(object, attributes, authenticated));</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Attempt to run as a different user</span></div><div class="line">     Authentication runAs = <span class="keyword">this</span>.runAsManager.buildRunAs(authenticated, object, attributes);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (runAs == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">if</span> (debug) &#123;</div><div class="line">             logger.debug(<span class="string">"RunAsManager did not change Authentication object"</span>);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         <span class="comment">// no further work post-invocation</span></div><div class="line">         <span class="keyword">return</span> <span class="keyword">new</span> InterceptorStatusToken(SecurityContextHolder.getContext(), <span class="keyword">false</span>, attributes, object);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">if</span> (debug) &#123;</div><div class="line">             logger.debug(<span class="string">"Switching to RunAs Authentication: "</span> + runAs);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         SecurityContext origCtx = SecurityContextHolder.getContext();</div><div class="line">         SecurityContextHolder.setContext(SecurityContextHolder.createEmptyContext());</div><div class="line">         SecurityContextHolder.getContext().setAuthentication(runAs);</div><div class="line"></div><div class="line">         <span class="comment">// need to revert to token.Authenticated post-invocation</span></div><div class="line">         <span class="keyword">return</span> <span class="keyword">new</span> InterceptorStatusToken(origCtx, <span class="keyword">true</span>, attributes, object);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p> For unauthorized request, <code>this.accessDecisionManager.decide(authenticated, object, attributes);</code> will throw the access denied exception.</p>
</li>
<li><p>ExceptionTranslationFilter caught the exception thrown in step 3, saves the origianl request, and triggers the authentication, i.e., the Entry point. Typically user will be redirected to login page or any other means of authentication.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">    HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">    HttpServletResponse response = (HttpServletResponse) res;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        chain.doFilter(request, response);</div><div class="line"></div><div class="line">        logger.debug(<span class="string">"Chain processed normally"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">        <span class="keyword">throw</span> ex;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">        <span class="comment">// Try to extract a SpringSecurityException from the stacktrace</span></div><div class="line">        Throwable[] causeChain = throwableAnalyzer.determineCauseChain(ex);</div><div class="line">        RuntimeException ase = (AuthenticationException)</div><div class="line">                throwableAnalyzer.getFirstThrowableOfType(AuthenticationException.class, causeChain);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ase == <span class="keyword">null</span>) &#123;</div><div class="line">            ase = (AccessDeniedException)throwableAnalyzer.getFirstThrowableOfType(AccessDeniedException.class, causeChain);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ase != <span class="keyword">null</span>) &#123;</div><div class="line">            handleSpringSecurityException(request, response, chain, ase);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Rethrow ServletExceptions and RuntimeExceptions as-is</span></div><div class="line">            <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ServletException) &#123;</div><div class="line">                <span class="keyword">throw</span> (ServletException) ex;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">                <span class="keyword">throw</span> (RuntimeException) ex;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Wrap other Exceptions. This shouldn't actually happen</span></div><div class="line">            <span class="comment">// as we've already covered all the possibilities for doFilter</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleSpringSecurityException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span></div><div class="line"><span class="function"><span class="params">        RuntimeException exception)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AuthenticationException) &#123;</div><div class="line">        logger.debug(<span class="string">"Authentication exception occurred; redirecting to authentication entry point"</span>, exception);</div><div class="line"></div><div class="line">        sendStartAuthentication(request, response, chain, (AuthenticationException) exception);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> AccessDeniedException) &#123;</div><div class="line">        <span class="keyword">if</span> (authenticationTrustResolver.isAnonymous(SecurityContextHolder.getContext().getAuthentication())) &#123;</div><div class="line">            logger.debug(<span class="string">"Access is denied (user is anonymous); redirecting to authentication entry point"</span>,</div><div class="line">                        exception);</div><div class="line"></div><div class="line">            sendStartAuthentication(request, response, chain, <span class="keyword">new</span> InsufficientAuthenticationException(</div><div class="line">                    <span class="string">"Full authentication is required to access this resource"</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            logger.debug(<span class="string">"Access is denied (user is not anonymous); delegating to AccessDeniedHandler"</span>, exception);</div><div class="line"></div><div class="line">            accessDeniedHandler.handle(request, response, (AccessDeniedException) exception);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendStartAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span></div><div class="line"><span class="function"><span class="params">        AuthenticationException reason)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    <span class="comment">// SEC-112: Clear the SecurityContextHolder's Authentication, as the</span></div><div class="line">    <span class="comment">// existing Authentication is no longer considered valid</span></div><div class="line">    SecurityContextHolder.getContext().setAuthentication(<span class="keyword">null</span>);</div><div class="line">    requestCache.saveRequest(request, response);</div><div class="line">    logger.debug(<span class="string">"Calling Authentication entry point."</span>);</div><div class="line">    authenticationEntryPoint.commence(request, response, reason);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>The sucuritycontextholder will be cleared when request is served.</p>
</li>
<li><p>Then entry point is definitely unprotected resource, otherwise we created an infinite loop.</p>
</li>
<li><p>When user’s credentials are available, e.g., login form post request, the posted url is usually protected to trigger security chain. In case of spring login form, the url is <strong>/j_spring_security_check</strong>. SecurityContext, again is restored along the way, with AnonymousUserToken created in step 2.</p>
</li>
<li><p>UsernamePasswordAuthenticationFilter is the filter to handle basic authentication request. It inherits the dofilter method from AbastractAuthenticationProcessingFilter.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"></div><div class="line">    HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">    HttpServletResponse response = (HttpServletResponse) res;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!requiresAuthentication(request, response)) &#123;</div><div class="line">        chain.doFilter(request, response);</div><div class="line"></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">        logger.debug(<span class="string">"Request is to process authentication"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Authentication authResult;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        authResult = attemptAuthentication(request, response);</div><div class="line">        <span class="keyword">if</span> (authResult == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// return immediately as subclass has indicated that it hasn't completed authentication</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        sessionStrategy.onAuthentication(authResult, request, response);</div><div class="line">    &#125; <span class="keyword">catch</span>(InternalAuthenticationServiceException failed) &#123;</div><div class="line">        logger.error(<span class="string">"An internal error occurred while trying to authenticate the user."</span>, failed);</div><div class="line">        unsuccessfulAuthentication(request, response, failed);</div><div class="line"></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (AuthenticationException failed) &#123;</div><div class="line">        <span class="comment">// Authentication failed</span></div><div class="line">        unsuccessfulAuthentication(request, response, failed);</div><div class="line"></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Authentication success</span></div><div class="line">    <span class="keyword">if</span> (continueChainBeforeSuccessfulAuthentication) &#123;</div><div class="line">        chain.doFilter(request, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    successfulAuthentication(request, response, chain, authResult);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> attemptAuthentication method simply encapsulates the username &amp; password in one UsernamePasswordAuthenticationToken instance and then<br> passes to the configured authentication manager to authenticate. Again, spring secuirty keeps the flexibility of the customization of the authentication mansger.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">"Authentication method not supported: "</span> + request.getMethod());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    String username = obtainUsername(request);</div><div class="line">    String password = obtainPassword(request);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (username == <span class="keyword">null</span>) &#123;</div><div class="line">        username = <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (password == <span class="keyword">null</span>) &#123;</div><div class="line">        password = <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    username = username.trim();</div><div class="line"></div><div class="line">    UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</div><div class="line"></div><div class="line">    <span class="comment">// Allow subclasses to set the "details" property</span></div><div class="line">    setDetails(request, authRequest);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>If the authentication is successful, the token will be saved, success event will be published.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></div><div class="line"><span class="function"><span class="params">        Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">        logger.debug(<span class="string">"Authentication success. Updating SecurityContextHolder to contain: "</span> + authResult);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SecurityContextHolder.getContext().setAuthentication(authResult);</div><div class="line"></div><div class="line">    rememberMeServices.loginSuccess(request, response, authResult);</div><div class="line"></div><div class="line">    <span class="comment">// Fire event</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.eventPublisher != <span class="keyword">null</span>) &#123;</div><div class="line">        eventPublisher.publishEvent(<span class="keyword">new</span> InteractiveAuthenticationSuccessEvent(authResult, <span class="keyword">this</span>.getClass()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    successHandler.onAuthenticationSuccess(request, response, authResult);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Configured successhandler will be invoked. If unspecified, SavedRequestAwareAuthenticationSuccessHandler is the default success handler. It will restore the original request from cache and redirect.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></div><div class="line"><span class="function"><span class="params">        Authentication authentication)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    SavedRequest savedRequest = requestCache.getRequest(request, response);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (savedRequest == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">super</span>.onAuthenticationSuccess(request, response, authentication);</div><div class="line"></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    String targetUrlParameter = getTargetUrlParameter();</div><div class="line">    <span class="keyword">if</span> (isAlwaysUseDefaultTargetUrl() || (targetUrlParameter != <span class="keyword">null</span> &amp;&amp; StringUtils.hasText(request.getParameter(targetUrlParameter)))) &#123;</div><div class="line">        requestCache.removeRequest(request, response);</div><div class="line">        <span class="keyword">super</span>.onAuthenticationSuccess(request, response, authentication);</div><div class="line"></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    clearAuthenticationAttributes(request);</div><div class="line"></div><div class="line">    <span class="comment">// Use the DefaultSavedRequest URL</span></div><div class="line">    String targetUrl = savedRequest.getRedirectUrl();</div><div class="line">    logger.debug(<span class="string">"Redirecting to DefaultSavedRequest Url: "</span> + targetUrl);</div><div class="line">    getRedirectStrategy().sendRedirect(request, response, targetUrl);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>As always the secuirty context is cleared when request processing cycle is completed.</p>
</li>
</ol>
<p>At last, when browser redirects to the protected source, the authenticated token was restored, and this time it passes through the FilterSecuirtyIntecptor, user is happy to access secured resources, as illustrated by step 12-14.</p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Java/">Java</a>, <a href="/tags/Spring-Security/">Spring Security</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>

</div></div>
    <aside id="sidebar" class="alignright">
  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Algorithm/">Algorithm</a><small>11</small></li>
  
    <li><a href="/tags/Angular/">Angular</a><small>1</small></li>
  
    <li><a href="/tags/Git/">Git</a><small>3</small></li>
  
    <li><a href="/tags/Go/">Go</a><small>4</small></li>
  
    <li><a href="/tags/Java/">Java</a><small>13</small></li>
  
    <li><a href="/tags/Javascript/">Javascript</a><small>4</small></li>
  
    <li><a href="/tags/Jekyll/">Jekyll</a><small>1</small></li>
  
    <li><a href="/tags/Linked-List/">Linked List</a><small>2</small></li>
  
    <li><a href="/tags/Linux/">Linux</a><small>1</small></li>
  
    <li><a href="/tags/Maven/">Maven</a><small>1</small></li>
  
    <li><a href="/tags/Network/">Network</a><small>1</small></li>
  
    <li><a href="/tags/Python/">Python</a><small>2</small></li>
  
    <li><a href="/tags/Regex/">Regex</a><small>3</small></li>
  
    <li><a href="/tags/SSL/">SSL</a><small>1</small></li>
  
    <li><a href="/tags/Spring/">Spring</a><small>2</small></li>
  
    <li><a href="/tags/Spring-Security/">Spring Security</a><small>1</small></li>
  
    <li><a href="/tags/Tool/">Tool</a><small>1</small></li>
  
    <li><a href="/tags/Training/">Training</a><small>1</small></li>
  
    <li><a href="/tags/Web-Service/">Web Service</a><small>1</small></li>
  
    <li><a href="/tags/XPath/">XPath</a><small>1</small></li>
  
    <li><a href="/tags/XSL/">XSL</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 <a href="mailto:coolcoolericwzc@163.com">Zhenchao Wang </a>
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>